{% extends 'app.html' %}

{% block title %}Scopes{% endblock %}

{% block content %}
<div class="container py-4" id="scope-page" data-stay-url="{{ url_for('scopes.list_scopes', stay=1) }}">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h4 mb-1">Scopes</h1>
            <p class="text-muted mb-0">Select a scope to view and manage its tasks.</p>
        </div>
        <button id="add-scope-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scope-modal">
            <i class="bi bi-plus-lg me-2" aria-hidden="true"></i>
            Add scope
        </button>
    </div>

    <div
        class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4{% if not scopes %} d-none{% endif %}"
        id="scopes-list"
        data-scope-list
    >
        {% for scope in scopes %}
            <div class="col d-flex" data-scope-id="{{ scope.id }}">
                <div
                    class="card h-100 w-100 border-secondary shadow-sm scope-card"
                    data-scope-id="{{ scope.id }}"
                    data-scope-url="{{ url_for('scopes.set_scope', scope_id=scope.id) }}"
                    data-scope-is-owner="{{ 'true' if scope.owner_id == g.user.id else 'false' }}"
                >
                    <div class="card-header bg-transparent border-0 pb-0">
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                {% if scope.owner_id == g.user.id %}
                                    <span id="grip" data-item-id="{{ scope.id }}" class="text-muted" title="Drag to reorder scopes">
                                        <i class="bi bi-grip-vertical"></i>
                                    </span>
                                {% else %}
                                    <span class="text-muted opacity-50">
                                        <i class="bi bi-grip-vertical"></i>
                                    </span>
                                {% endif %}
                                {% if scope.github_integration_enabled %}
                                    <span class="badge text-bg-primary d-inline-flex align-items-center gap-1">
                                        <i class="bi bi-github" aria-hidden="true"></i>
                                        GitHub
                                    </span>
                                {% endif %}
                                {% if scope.owner_id != g.user.id %}
                                    <span class="badge text-bg-light text-muted">Shared</span>
                                {% endif %}
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Scope actions">
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary scope-copy-btn"
                                    data-scope-id="{{ scope.id }}"
                                    data-scope-name="{{ scope.name | e }}"
                                    data-export-url="{{ url_for('scopes.export_scope_tasks', scope_id=scope.id) }}"
                                    aria-label="Copy tasks for scope {{ scope.name }}"
                                >
                                    <i class="bi bi-clipboard" aria-hidden="true"></i>
                                </button>
                                {% if scope.owner_id == g.user.id %}
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary edit-scope-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#scope-modal"
                                        data-scope-id="{{ scope.id }}"
                                        data-scope-name="{{ scope.name | default('') | e }}"
                                        data-scope-description="{{ scope.description | default('') | e }}"
                                        data-scope-github_enabled="{{ 'true' if scope.github_integration_enabled else 'false' }}"
                                        data-scope-github_repository='{{ {'id': scope.github_repo_id, 'name': scope.github_repo_name, 'owner': scope.github_repo_owner} | tojson if scope.github_repo_owner and scope.github_repo_name else '' }}'
                                        data-scope-github_project='{{ {'id': scope.github_project_id, 'name': scope.github_project_name} | tojson if scope.github_project_id and scope.github_project_name else '' }}'
                                        data-scope-github_milestone='{{ {'number': scope.github_milestone_number, 'title': scope.github_milestone_title} | tojson if scope.github_milestone_number and scope.github_milestone_title else '' }}'
                                        aria-label="Edit scope {{ scope.name }}"
                                    >
                                        <i class="bi bi-pencil" aria-hidden="true"></i>
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-dark scope-delete-btn"
                                        data-confirm-url="{{ url_for('delete_item', item_type='scope', id=scope.id) }}"
                                        data-scope-name="{{ scope.name | e }}"
                                        data-scope-id="{{ scope.id }}"
                                        aria-label="Delete scope {{ scope.name }}"
                                    >
                                        <i class="bi bi-trash3" aria-hidden="true"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-body position-relative d-flex flex-column">
                        <h2 class="h5 text-dark mb-2">{{ scope.name }}</h2>
                        {% if scope.description %}
                            <p class="text-muted small mb-0">{{ scope.description }}</p>
                        {% endif %}
                        <a
                            class="stretched-link text-decoration-none"
                            href="{{ url_for('scopes.set_scope', scope_id=scope.id) }}"
                            data-scope-id="{{ scope.id }}"
                            aria-label="Open scope {{ scope.name }}"
                        ></a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="card border-secondary shadow-sm{% if scopes %} d-none{% endif %}" data-scope-empty>
        <div class="card-body text-center py-5">
            <p class="lead mb-2">No scopes yet</p>
            <p class="text-muted mb-4">Create a scope to start organizing your tasks into focused groups.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scope-modal">
                <i class="bi bi-plus-lg me-2" aria-hidden="true"></i>
                Create your first scope
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
    {{ super() }}
    {% include "modals/scope_modal.html" %}
{% endblock modals %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/scope_form.js') }}"></script>
{% endblock scripts %}
