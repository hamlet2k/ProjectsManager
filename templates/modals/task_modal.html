<div class="modal fade" id="task-modal" tabindex="-1" aria-labelledby="task-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="task-modal-title">{{ action }} Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="task-form" method="post">
            {{ task_form.hidden_tag() }}

            <div class="modal-body pt-2">
                <p class="text-muted small mb-3" id="task-modal-description">Capture the details for this task below.</p>
                <div class="form-floating mb-3">
                    {{ task_form.name(class_='form-control'+ (' is-invalid' if task_form.name.errors else ''), placeholder_=task_form.name.name) }}
                    {{ task_form.name.label(class="form-label") }}
                    {% if task_form.name.errors %}
                        {% for error in task_form.name.errors %}
                            <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-floating mb-3">
                    {{ task_form.description(class_='form-control'+ (' is-invalid' if task_form.description.errors else ''), placeholder_=task_form.description.name) }}
                    {{ task_form.description.label(class="form-label") }}
                    {% if task_form.description.errors %}
                        {% for error in task_form.description.errors %}
                            <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-floating mb-3">
                    {{ task_form.end_date(class_='form-control'+ (' is-invalid' if task_form.end_date.errors else ''), placeholder_=task_form.end_date.name) }}
                    {{ task_form.end_date.label(class="form-label") }}
                    {% if task_form.end_date.errors %}
                        {% for error in task_form.end_date.errors %}
                            <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Cancel
                </button>
                <button type="submit" class="btn btn-primary" name="submitTaskButton" id="submitTaskButton">
                Save Task
                </button>
            </div>
                
            </form>
        </div>
    </div>
</div>

<script>
    // Display the modal based on the flag.
    // Used when validation of the form fails to display the modal by default.
    // Sets the modal butons depending on the action clicked (ADD or EDIT)
    document.addEventListener('DOMContentLoaded', (event) => {
        {% if show_modal %}
            var modal = new bootstrap.Modal(document.getElementById('{{show_modal}}'));
            modal.show();
        {% endif %}
    });

    // Update the form action when the ADD button is clicked
    // Clears the form fields
    document.getElementById("add-task-btn").addEventListener("click", (event) => {
        actionUrl = '{{ url_for("add_task") }}';
        document.querySelector("#task-form").action = actionUrl;
        document.getElementById("task-form").reset();
        //clearFormFields();
    });

    // Update the modal form action when the EDIT button is clicked
    // Populate the form with the values associated to the EDIT button
    document.querySelectorAll(".edit-task-btn").forEach((item) => {
        item.addEventListener("click", (event) => {
            {% for field in task_form %}
                {% if field.name != 'csrf_token' and field.type != 'SubmitField' %}
                    document.getElementById('{{ field.name }}').value = item.getAttribute("data-task-{{ field.name }}");
                {% endif %}
            {% endfor %}

            let baseUrl = '{{ url_for("edit_task", id=0) }}';
            let actionUrl = baseUrl.replace("/0", "/" + item.getAttribute("data-task-id"));
            document.querySelector("#task-form").action = actionUrl;
        });
    });

    function clearFormFields(){
        {% for field in task_form %}
            {% if field.name != 'csrf_token' %}
                document.getElementById('{{ field.name }}').value = "";
            {% endif %}
        {% endfor %}
    };

    // Convert DateTimeLocalField to UTC before to to submit the form
    document.getElementById('task-form').addEventListener('submit', function(event) {
        event.preventDefault();  // Prevent the default form submission
        {% for field in task_form %}
            {% if field.type == 'DateTimeLocalField' %}
                if (document.getElementById('{{ field.name }}').value != '') {
                    document.getElementById('{{ field.name }}').value = convertToUTC(document.getElementById('{{ field.name }}').value)
                }
            {% endif %}
        {% endfor %}
        this.submit();
    });

    function convertToUTC(dateString){
        var localDateTime = new Date(dateString);
        return localDateTime.toISOString().slice(0, 16);
    };

</script>
