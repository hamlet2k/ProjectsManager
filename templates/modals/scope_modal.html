<div class="modal fade" id="scope-modal" tabindex="-1" aria-labelledby="scope-modal-title" aria-hidden="true" data-open-on-load="{{ 'true' if show_modal else 'false' }}">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="scope-modal-title">Create scope</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="scope-form" method="post" data-create-url="{{ url_for('scopes.add_scope') }}" data-edit-url-template="{{ url_for('scopes.edit_scope', scope_id=0) }}" data-github-token-present="{{ 'true' if github_token_present else 'false' }}" data-initial-state='{{ scope_form_state | tojson | safe }}'>
            {{ scope_form.hidden_tag() }}

            <div class="modal-body">
                <p class="text-muted small mb-3" id="scope-modal-description">Group related tasks by creating a new scope.</p>
                <div class="form-floating mb-3">
                    {{ scope_form.name(class_='form-control'+ (' is-invalid' if scope_form.name.errors else ''), placeholder_=scope_form.name.name, **{'data-field': 'name'}) }}
                    {{ scope_form.name.label(class="form-label") }}
                    <div class="invalid-feedback{% if scope_form.name.errors %} d-block{% endif %}" data-field-errors="name">
                        {% for error in scope_form.name.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-floating mb-3">
                    {{ scope_form.description(
                        class_='form-control'+ (' is-invalid' if scope_form.description.errors else ''),
                        placeholder_=scope_form.description.name,
                        rows=3,
                        **{
                            'data-field': 'description',
                            'data-autoresize': 'scope-description',
                            'data-collapsed-lines': '3'
                        }
                    ) }}
                    {{ scope_form.description.label(class="form-label") }}
                    <div class="invalid-feedback{% if scope_form.description.errors %} d-block{% endif %}" data-field-errors="description">
                        {% for error in scope_form.description.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="mb-3 pt-3 border-top">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h6 class="mb-1">GitHub Integration</h6>
                            <p class="text-muted small mb-0">Connect tasks in this scope to a specific repository.</p>
                        </div>
                        <div class="form-check form-switch">
                            {{ scope_form.github_enabled(class="form-check-input", id="scope-github-toggle", disabled=not github_token_present, **{'data-field': 'github_enabled'}) }}
                            <label class="form-check-label" for="scope-github-toggle">Enable</label>
                        </div>
                    </div>
                    {% if not github_token_present %}
                        <div class="alert alert-info py-2 px-3 mb-2" role="alert">
                            Add a GitHub token in your user settings to enable integration.
                        </div>
                    {% endif %}
                    <div class="github-scope-settings" data-github-settings-section>
                        <div class="mb-3">
                            <label class="form-label" for="scope-github-repo-select">Repository</label>
                            {{ scope_form.github_repository(class="form-select" + (' is-invalid' if scope_form.github_repository.errors else ''), id="scope-github-repo-select", **{'data-selected-repo': scope_form.github_repository.data or '', 'data-field': 'github_repository'}) }}
                            <div class="invalid-feedback{% if scope_form.github_repository.errors %} d-block{% endif %}" data-field-errors="github_repository">
                                {% for error in scope_form.github_repository.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Choose the repository to use for GitHub actions in this scope.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="scope-github-project-select">Project <span class="text-muted">(optional)</span></label>
                            {{ scope_form.github_project(class="form-select" + (' is-invalid' if scope_form.github_project.errors else ''), id="scope-github-project-select", **{'data-selected-project': scope_form.github_project.data or '', 'data-field': 'github_project'}) }}
                            <div class="invalid-feedback{% if scope_form.github_project.errors %} d-block{% endif %}" data-field-errors="github_project">
                                {% for error in scope_form.github_project.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Automatically add new issues to this GitHub project.</div>
                        </div>
                        <div class="alert alert-info py-2 px-3 d-none" data-github-shared-notice role="alert">
                            These fields are managed by the scope owner since you share the same repository.
                        </div>
                        <div class="alert alert-warning py-2 px-3 d-none" data-github-project-warning role="alert">
                            Unable to load projects for this repository. Ensure your GitHub token includes project access.
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="scope-github-milestone-select">Milestone <span class="text-muted">(optional)</span></label>
                            {{ scope_form.github_milestone(class="form-select" + (' is-invalid' if scope_form.github_milestone.errors else ''), id="scope-github-milestone-select", **{'data-selected-milestone': scope_form.github_milestone.data or '', 'data-field': 'github_milestone'}) }}
                            <div class="invalid-feedback{% if scope_form.github_milestone.errors %} d-block{% endif %}" data-field-errors="github_milestone">
                                {% for error in scope_form.github_milestone.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Use this milestone as the default for new issues.</div>
                        </div>
                        <div class="alert alert-warning py-2 px-3 d-none" data-github-milestone-warning role="alert">
                            Unable to load milestones for this repository. Ensure your GitHub token includes milestone access.
                        </div>
                        <div class="alert alert-warning py-2 px-3 d-none" data-github-warning role="alert">
                            A repository must be selected to enable GitHub integration for this scope.
                        </div>
                    </div>
                    <div class="invalid-feedback{% if scope_form.github_enabled.errors %} d-block{% endif %}" data-field-errors="github_enabled">
                        {% for error in scope_form.github_enabled.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Cancel
                </button>
                {{ scope_form.submit(class="btn btn-primary", **{'data-field': 'submit'}) }}
            </div>

            </form>
        </div>
    </div>
</div>

