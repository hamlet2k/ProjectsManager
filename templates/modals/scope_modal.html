<div class="modal fade" id="scope-modal" tabindex="-1" aria-labelledby="scope-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="scope-modal-title">Create scope</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="scope-form" method="post">
            {{ scope_form.hidden_tag() }}

            <div class="modal-body">
                <p class="text-muted small mb-3" id="scope-modal-description">Group related tasks by creating a new scope.</p>
                <div class="form-floating mb-3">
                    {{ scope_form.name(class_='form-control'+ (' is-invalid' if scope_form.name.errors else ''), placeholder_=scope_form.name.name) }}
                    {{ scope_form.name.label(class="form-label") }}
                    {% if scope_form.name.errors %}
                        {% for error in scope_form.name.errors %}
                            <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-floating mb-3">
                    {{ scope_form.description(class_='form-control'+ (' is-invalid' if scope_form.description.errors else ''), placeholder_=scope_form.description.name) }}
                    {{ scope_form.description.label(class="form-label") }}
                    {% if scope_form.description.errors %}
                        {% for error in scope_form.description.errors %}
                            <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Cancel
                </button>
                {{ scope_form.submit(class="btn btn-primary") }}
            </div>

            </form>
        </div>
    </div>
</div>

<script>
    const scopeForm = document.getElementById('scope-form');
    const scopeModalTitle = document.getElementById('scope-modal-title');
    const scopeModalDescription = document.getElementById('scope-modal-description');
    const scopeSubmitButton = scopeForm ? scopeForm.querySelector('[type="submit"]') : null;

    function setScopeModalContent({ title, description, submitLabel }) {
        if (scopeModalTitle) {
            scopeModalTitle.textContent = title;
        }
        if (scopeModalDescription) {
            scopeModalDescription.textContent = description;
        }
        if (scopeSubmitButton) {
            scopeSubmitButton.value = submitLabel;
            scopeSubmitButton.textContent = submitLabel;
        }
    }

    function buildCreateScopeDescription() {
        return 'Provide a name and optional description to group related tasks.';
    }

    function buildEditScopeDescription(name = '') {
        if (name && name.trim().length > 0) {
            return `Update the details for "${name.trim()}" before saving your changes.`;
        }
        return 'Update the scope details before saving your changes.';
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize with create scope content by default
        if (scopeForm) {
            setScopeModalContent({
                title: 'Create scope',
                description: buildCreateScopeDescription(),
                submitLabel: 'Create scope',
            });
        }

        {% if show_modal %}
            const modal = new bootstrap.Modal(document.getElementById('{{ show_modal }}'));
            modal.show();
        {% endif %}
    });

    const addScopeBtn = document.getElementById('add-scope-btn');
    if (addScopeBtn && scopeForm) {
        addScopeBtn.addEventListener('click', () => {
            scopeForm.action = '{{ url_for("add_scope") }}';
            scopeForm.reset();
            setScopeModalContent({
                title: 'Create scope',
                description: buildCreateScopeDescription(),
                submitLabel: 'Create scope',
            });
        });
    }

    document.querySelectorAll('.edit-scope-btn').forEach((item) => {
        item.addEventListener('click', () => {
            {% for field in scope_form %}
                {% if field.name != 'csrf_token' and field.type != 'SubmitField' %}
                    const fieldElement_{{ field.name }} = document.getElementById('{{ field.name }}');
                    if (fieldElement_{{ field.name }}) {
                        fieldElement_{{ field.name }}.value = item.getAttribute('data-scope-{{ field.name }}') || '';
                    }
                {% endif %}
            {% endfor %}

            if (scopeForm) {
                const baseUrl = '{{ url_for("edit_scope", id=0) }}';
                const actionUrl = baseUrl.replace('/0', `/${item.getAttribute('data-scope-id')}`);
                scopeForm.action = actionUrl;
            }

            setScopeModalContent({
                title: 'Edit scope',
                description: buildEditScopeDescription(item.getAttribute('data-scope-name') || ''),
                submitLabel: 'Save changes',
            });
        });
    });
</script>

