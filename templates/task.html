{% extends 'app.html' %}

{% block title %}Tasks{% endblock %}

{% block css %}
{{ super() }}
<style>
    .tag-chip,
    .tag-pill {
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border: 1px solid var(--bs-border-color);
        transition: all 0.15s ease-in-out;
    }

    .tag-chip {
        cursor: pointer;
        background-color: transparent;
        color: var(--bs-body-color);
    }

    .tag-chip:hover {
        background-color: var(--bs-tertiary-bg);
    }

    .tag-chip.active,
    .tag-chip.assigned {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        color: var(--bs-white);
    }

    .tag-chip.assigned:not(.active) {
        background-color: var(--bs-secondary);
        border-color: var(--bs-secondary);
    }

    .tag-pill {
        background-color: var(--bs-tertiary-bg);
        border-color: transparent;
        color: var(--bs-secondary-color, var(--bs-secondary));
    }

    .tag-section-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--bs-secondary-color, var(--bs-secondary));
    }

    .tag-filter-toolbar {
        background-color: var(--bs-body-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--bs-border-color);
        padding: 0.75rem 1rem;
    }

    .drag-disabled {
        opacity: 0.35;
        cursor: default !important;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}

<div class="container">
    <div class="tag-filter-toolbar d-flex flex-column gap-3">
        <form action="{{ url_for('task') }}" method="get" class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
                <label for="search" class="form-label">Search tasks</label>
                <input type="search" class="form-control form-control-sm" id="search" name="search" value="{{ search_query }}" placeholder="Search by name or description">
            </div>
            <div class="col-12 col-md-3">
                <label for="sort_by" class="form-label">Sort by</label>
                <select class="form-select form-select-sm" id="sort_by" name="sort_by" onchange="this.form.submit()">
                    <option value="rank" {{ 'selected' if sort_by == 'rank' else '' }}>Rank</option>
                    <option value="name" {{ 'selected' if sort_by == 'name' else '' }}>Name</option>
                    <option value="tags" {{ 'selected' if sort_by == 'tags' else '' }}>Tags</option>
                    <option value="due_date" {{ 'selected' if sort_by == 'due_date' else '' }}>Due date</option>
                </select>
            </div>
            <div class="col-12 col-md-3">
                <div class="form-check form-switch mt-md-4 pt-1">
                    <input class="form-check-input" type="checkbox" role="switch" id="filter-completed" name="show_completed" value="true" onchange="this.form.submit()" {{ 'checked' if show_completed else '' }}>
                    <label class="form-check-label" for="filter-completed">Show completed tasks</label>
                </div>
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-outline-secondary w-100">Apply</button>
            </div>
        </form>
        <div class="d-flex flex-column flex-lg-row gap-2 align-items-lg-center">
            <div class="d-flex align-items-center gap-2">
                <span class="tag-section-label mb-0">Filter by tags</span>
                <a href="#" class="small text-decoration-none" id="tag-filter-clear">clear</a>
            </div>
            <div class="d-flex flex-wrap gap-2" id="tag-filter-container">
                {% for tag in available_tags %}
                    <button type="button" class="btn btn-sm tag-chip tag-filter-button" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">#{{ tag.name }}</button>
                {% endfor %}
            </div>
            <p class="text-muted mb-0 small {% if available_tags %}d-none{% endif %}" id="tag-filter-empty">
                No tags yet. Add tags to tasks to start filtering.
            </p>
        </div>
    </div>
</div>

<div class="container mt-2">
    <form id="task-form" method="post" action="{{ url_for('add_task') }}">
        {{ task_form.hidden_tag() }}
        <div  class="accordion" id="quick-item-accordion">
            <div class="input-group mb-3">
                <span class="input-group-text clickable-icon collapsed" data-bs-toggle="collapse" data-bs-target="#detailed-item-container">
                    <i class="bi bi-chevron-down text-muted"></i>
                </span>
                {{ task_form.name(class_='form-control'+ (' is-invalid' if task_form.name.errors else ''), placeholder_="Add new task...") }}
                <button id="quick-add-btn" class="btn btn-primary" type="submit">
                    <i class="bi bi-floppy"></i>
                </button>
                <button id="quick-cancel-btn" class="btn btn-secondary" type="reset">
                    <i class="bi bi-x-circle"></i>
                </button>
                {% if task_form.name.errors %}
                    {% for error in task_form.name.errors %}
                        <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        <div id="detailed-item-container" class="accordion-collapse collapse" data-bs-parent="#quick-item-accordion">
            <div class="accordion-body">
                <div class="form-floating mb-3">
                {{ task_form.description(class_='form-control') }}
                {{ task_form.description.label(class_='form-label') }}
                {% if task_form.description.errors %}
                    {% for error in task_form.description.errors %}
                        <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                    {% endfor %}
                {% endif %}
                </div>
                <div class="form-floating mb-3">
                {{ task_form.end_date(class_='form-control') }}
                {{ task_form.end_date.label(class_='form-label') }}
                {% if task_form.end_date.errors %}
                    {% for error in task_form.end_date.errors %}
                        <div class="invalid-feedback" style="display:block;">{{ error }}</div>
                    {% endfor %}
                {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>

<div class="container mt-2">
    {% set ns = namespace(has_tasks=false) %}
    {% for group in task_groups %}
        {% if group.tasks %}
            {% set ns.has_tasks = true %}
        {% endif %}
        <div class="task-group mb-4">
            {% if group.title %}
                <h6 class="text-uppercase text-muted small mb-2">{{ group.title }}</h6>
            {% endif %}
            <div class="accordion" id="{{ group.dom_id }}" data-sortable="{{ 'true' if group.sortable else 'false' }}">
                {% if group.tasks %}
                    {% for task in group.tasks %}
                        <div class="m-1 px-2 sketchy-border task-item" data-task-id="{{ task.id }}" data-tag-ids="{{ task.tags | map(attribute='id') | join(',') }}">
                            <div class="d-flex justify-content-between align-items-center my-1" id="heading{{ group.dom_id }}-{{ task.id }}">
                                <a href="#" class="text-decoration-none no-visited flex-grow-1" data-bs-toggle="collapse" data-bs-target="#collapse{{ group.dom_id }}-{{ task.id }}">
                                    <div class="col d-flex">
                                        <i class="bi bi-grip-vertical text-muted {{ '' if group.sortable else 'drag-disabled' }}" id="grip" data-item-id="{{ task.id }}"></i>
                                        <div class="mx-2">
                                            {% if task.completed %}
                                                <del>{{ task.name }}</del>
                                            {% else %}
                                                {{ task.name }}
                                            {% endif %}
                                            <div class="d-flex flex-wrap gap-2 mt-1" id="task-tags-{{ task.id }}">
                                                {% for tag in task.tags %}
                                                    <span class="tag-pill" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">#{{ tag.name }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                <div class="col-4 d-flex justify-content-end">
                                    <a class="btn btn-outline-success mx-1" href="{{ url_for('complete_task', id=task.id) }}">
                                        {% if task.completed %}
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        {% else %}
                                            <i class="bi bi-check"></i>
                                        {% endif %}
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary tag-manager-btn" data-task-id="{{ task.id }}" data-task-name="{{ task.name }}">
                                        <i class="bi bi-tags"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary mx-1 edit-task-btn"
                                        data-task-id="{{ task.id }}"
                                        data-task-name="{{ task.name }}"
                                        data-task-description="{{ task.description }}"
                                        data-task-end_date="{{ task.end_date }}"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="showConfirmationModal('{{ url_for('delete_item', item_type='task', id=task.id) }}','Confirm Action','Are you sure?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="collapse{{ group.dom_id }}-{{ task.id }}" class="accordion-collapse collapse" data-bs-parent="#{{ group.dom_id }}">
                                {% if task.description or task.end_date %}
                                <div class="accordion-body">
                                    {% if task.end_date %}
                                        <i class="bi bi-calendar3 small text-muted" utc-date="{{ task.end_date }}"></i>
                                    {% endif %}
                                    {% if task.description %}
                                        <p class="small">{{ task.description }}</p>
                                    {% endif %}
                                    {% for subtask in task.subtasks %}
                                        <div class="ms-3">
                                            <strong>{{ subtask.name }}</strong> - {{ subtask.description }}
                                        </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small mb-0">No tasks in this group.</p>
                {% endif %}
            </div>
        </div>
    {% endfor %}
    {% if not ns.has_tasks %}
        <p class="text-muted fst-italic">No tasks match the selected filters.</p>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
    {{ super() }}
    <div class="modal fade" id="tagManagerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage tags</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2" id="tag-modal-task-name"></p>
                    <div class="mb-3">
                        <div class="d-flex flex-wrap gap-2" id="tag-modal-available"></div>
                        <p class="text-muted small mb-0 d-none" id="tag-modal-empty">No tags yet. Create one below.</p>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">#</span>
                        <input type="text" class="form-control" id="new-tag-input" placeholder="Create a new tag">
                        <button class="btn btn-outline-primary" id="create-tag-btn" type="button">Add</button>
                    </div>
                    <div class="invalid-feedback d-none" id="new-tag-feedback">Please enter a tag name.</div>
                </div>
            </div>
        </div>
    </div>
{% endblock modals %}

{% block scripts %}
{{ super() }}
<script>

    const sortableGroupIds = {{ sortable_group_ids | tojson }};
    if (Array.isArray(sortableGroupIds) && sortableGroupIds.length > 0) {
        sortableGroupIds.forEach((groupId) => {
            initializeSortable(groupId, 'task');
        });
    }

    // Update the form action to ADD when the form is reset
    document.getElementById("quick-cancel-btn").addEventListener("click", (event) => {
        actionUrl = '{{ url_for("add_task") }}';
        document.querySelector("#task-form").action = actionUrl;
        collapseAccordionItem('detailed-item-container');
    });

    // Update the form action to EDIT and the ID of the task
    // Populate the form with the data-task-* attributes in the EDIT button
    document.querySelectorAll(".edit-task-btn").forEach((item) => {
        item.addEventListener("click", (event) => {
            {% for field in task_form %}
                {% if field.name != 'csrf_token' and field.type != 'SubmitField' %}
                    document.getElementById('{{ field.name }}').value = item.getAttribute("data-task-{{ field.name }}");
                {% endif %}
            {% endfor %}

            let baseUrl = '{{ url_for("edit_task", id=0) }}';
            let actionUrl = baseUrl.replace("/0", "/" + item.getAttribute("data-task-id"));
            document.querySelector("#task-form").action = actionUrl;
            expandAccordionItem('detailed-item-container');
        });
    });

    document.querySelectorAll(".bi-calendar3").forEach((item) => {
        local_date = convertToLocal(item.getAttribute("utc-date"));
        formated_date = new Date(local_date).toLocaleDateString(undefined, {
            year: 'numeric', 
            month: 'short', 
            day: 'numeric', 
            hour: 'numeric', 
            minute: 'numeric'
        });
        //item.setAttribute("data-bs-original-title", 'Due: ' + formated_date);
        //item.setAttribute("title", 'Due: ' + formated_date);
        item.setAttribute("aria-label", 'Due: ' + formated_date);
        item.innerHTML = ' Due: ' + formated_date;
    });

    function convertToLocal(utcDateString){
        // Parse the UTC date string to a Date object
        var date = new Date(utcDateString + 'z'); //add zulu time since datetime-local doesnt have it

        // Format the date to a local datetime-local string
        function pad(number) {
            return number < 10 ? '0' + number : number;
        }
        var yyyy = date.getFullYear();
        var MM = pad(date.getMonth() + 1); // Months are 0-based in JavaScript
        var dd = pad(date.getDate());
        var hh = pad(date.getHours());
        var mm = pad(date.getMinutes());

        return yyyy + '-' + MM + '-' + dd + 'T' + hh + ':' + mm;
    };

    const csrfTokenInput = document.querySelector('#task-form input[name="csrf_token"]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;

    const tagModalElement = document.getElementById('tagManagerModal');
    const tagModal = tagModalElement ? new bootstrap.Modal(tagModalElement) : null;
    const tagModalAvailable = document.getElementById('tag-modal-available');
    const tagModalEmpty = document.getElementById('tag-modal-empty');
    const tagModalTaskName = document.getElementById('tag-modal-task-name');
    const newTagInput = document.getElementById('new-tag-input');
    const newTagFeedback = document.getElementById('new-tag-feedback');
    const createTagBtn = document.getElementById('create-tag-btn');

    const filterContainer = document.getElementById('tag-filter-container');
    const filterClear = document.getElementById('tag-filter-clear');
    const filterEmptyMessage = document.getElementById('tag-filter-empty');

    let availableTagsMap = new Map();
    let currentTaskId = null;
    let currentTaskTags = new Map();

    function hydrateAvailableTagsFromFilter() {
        if (!filterContainer) {
            return;
        }
        availableTagsMap = new Map();
        filterContainer.querySelectorAll('[data-tag-id]').forEach((button) => {
            availableTagsMap.set(button.dataset.tagId, {
                id: Number(button.dataset.tagId),
                name: button.dataset.tagName,
            });
        });
        if (filterEmptyMessage) {
            filterEmptyMessage.classList.toggle('d-none', availableTagsMap.size > 0);
        }
    }

    function ensureTagInFilter(tag) {
        if (!filterContainer || !tag) {
            return;
        }
        const tagId = String(tag.id);
        if (!availableTagsMap.has(tagId)) {
            availableTagsMap.set(tagId, tag);
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-sm tag-chip tag-filter-button';
            button.dataset.tagId = tagId;
            button.dataset.tagName = tag.name;
            button.textContent = `#${tag.name}`;
            button.addEventListener('click', handleFilterToggle);
            filterContainer.appendChild(button);
        }
        if (filterEmptyMessage) {
            filterEmptyMessage.classList.add('d-none');
        }
    }

    function updateTaskTagDisplay(taskId, tags) {
        const container = document.getElementById(`task-tags-${taskId}`);
        if (container) {
            container.innerHTML = '';
            tags.forEach((tag) => {
                const pill = document.createElement('span');
                pill.className = 'tag-pill';
                pill.dataset.tagId = tag.id;
                pill.dataset.tagName = tag.name;
                pill.textContent = `#${tag.name}`;
                container.appendChild(pill);
            });
        }

        const taskWrapper = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
        if (taskWrapper) {
            const tagIds = tags.map((tag) => tag.id);
            taskWrapper.dataset.tagIds = tagIds.join(',');
        }
    }

    function renderTagOptions() {
        if (!tagModalAvailable) {
            return;
        }

        // Ensure tags from filters are included before rendering
        hydrateAvailableTagsFromFilter();
        currentTaskTags.forEach((tag) => ensureTagInFilter(tag));

        tagModalAvailable.innerHTML = '';
        const tags = Array.from(availableTagsMap.values()).sort((a, b) => a.name.localeCompare(b.name));

        if (tags.length === 0) {
            if (tagModalEmpty) {
                tagModalEmpty.classList.remove('d-none');
            }
            return;
        }

        if (tagModalEmpty) {
            tagModalEmpty.classList.add('d-none');
        }

        tags.forEach((tag) => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'btn btn-sm tag-chip';
            chip.dataset.tagId = tag.id;
            chip.textContent = `#${tag.name}`;
            if (currentTaskTags.has(String(tag.id))) {
                chip.classList.add('active', 'assigned');
            }
            chip.addEventListener('click', () => toggleTagAssignment(tag));
            tagModalAvailable.appendChild(chip);
        });
    }

    function toggleTagAssignment(tag) {
        const tagId = String(tag.id);
        if (currentTaskTags.has(tagId)) {
            updateTagAssignment(tagId, false);
        } else {
            updateTagAssignment(tagId, true);
        }
    }

    function updateTagAssignment(tagId, assign) {
        if (!currentTaskId || !csrfToken) {
            return;
        }

        const url = assign ? `/tasks/${currentTaskId}/tags` : `/tasks/${currentTaskId}/tags/${tagId}`;
        const options = {
            method: assign ? 'POST' : 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
        };

        if (assign) {
            options.body = JSON.stringify({ tag_id: Number(tagId) });
        }

        fetch(url, options)
            .then((response) => {
                if (!response.ok) {
                    throw response;
                }
                return response.json();
            })
            .then((data) => {
                if (data && data.tag) {
                    const tag = data.tag;
                    const tagKey = String(tag.id);
                    if (assign) {
                        currentTaskTags.set(tagKey, tag);
                        ensureTagInFilter(tag);
                    } else {
                        currentTaskTags.delete(tagKey);
                    }
                    updateTaskTagDisplay(currentTaskId, Array.from(currentTaskTags.values()));
                    renderTagOptions();
                    applyTagFilters();
                }
            })
            .catch((error) => {
                console.error('Unable to update tag assignment', error);
            });
    }

    function handleCreateTag() {
        if (!newTagInput || !csrfToken || !currentTaskId) {
            return;
        }

        const rawValue = newTagInput.value.trim();
        const normalized = rawValue.replace(/^#+/, '').trim();

        if (!normalized) {
            if (newTagFeedback) {
                newTagFeedback.textContent = 'Please enter a tag name.';
                newTagFeedback.classList.remove('d-none');
            }
            return;
        }

        if (newTagFeedback) {
            newTagFeedback.classList.add('d-none');
        }

        fetch('/tags', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ name: normalized }),
        })
            .then((response) => {
                if (!response.ok) {
                    return response.json().then((data) => Promise.reject(data));
                }
                return response.json();
            })
            .then((data) => {
                if (!data || !data.tag) {
                    return;
                }
                const tag = data.tag;
                const tagKey = String(tag.id);
                availableTagsMap.set(tagKey, tag);
                ensureTagInFilter(tag);
                newTagInput.value = '';
                renderTagOptions();
                updateTagAssignment(tagKey, true);
            })
            .catch((error) => {
                if (newTagFeedback) {
                    const message = error && error.error ? error.error : 'Unable to create tag.';
                    newTagFeedback.textContent = message;
                    newTagFeedback.classList.remove('d-none');
                }
            });
    }

    function handleFilterToggle(event) {
        event.preventDefault();
        const button = event.currentTarget;
        button.classList.toggle('active');
        applyTagFilters();
    }

    function applyTagFilters() {
        const activeTags = filterContainer
            ? Array.from(filterContainer.querySelectorAll('.tag-chip.active')).map((button) => button.dataset.tagId)
            : [];

        document.querySelectorAll('.task-item').forEach((taskElement) => {
            const taskTags = (taskElement.dataset.tagIds || '').split(',').filter(Boolean);
            const matches = activeTags.every((tagId) => taskTags.includes(tagId));
            taskElement.style.display = matches ? '' : 'none';
        });
    }

    function attachFilterListeners() {
        if (!filterContainer) {
            return;
        }
        filterContainer.querySelectorAll('.tag-filter-button').forEach((button) => {
            button.addEventListener('click', handleFilterToggle);
        });

        if (filterClear) {
            filterClear.addEventListener('click', (event) => {
                event.preventDefault();
                filterContainer.querySelectorAll('.tag-chip').forEach((button) => {
                    button.classList.remove('active');
                });
                applyTagFilters();
            });
        }
    }

    function attachTagManagerListeners() {
        document.querySelectorAll('.tag-manager-btn').forEach((button) => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                if (!tagModal) {
                    return;
                }

                currentTaskId = button.dataset.taskId;
                currentTaskTags = new Map();

                if (tagModalTaskName) {
                    tagModalTaskName.textContent = `Tags for "${button.dataset.taskName || ''}"`;
                }

                const tagContainer = document.getElementById(`task-tags-${currentTaskId}`);
                if (tagContainer) {
                    tagContainer.querySelectorAll('[data-tag-id]').forEach((pill) => {
                        const id = String(pill.dataset.tagId);
                        currentTaskTags.set(id, {
                            id: Number(id),
                            name: pill.dataset.tagName || pill.textContent.replace('#', '').trim(),
                        });
                    });
                }

                renderTagOptions();

                if (newTagInput) {
                    newTagInput.value = '';
                    newTagInput.focus({ preventScroll: true });
                }

                if (newTagFeedback) {
                    newTagFeedback.classList.add('d-none');
                }

                tagModal.show();
            });
        });
    }

    attachFilterListeners();
    hydrateAvailableTagsFromFilter();
    attachTagManagerListeners();
    applyTagFilters();

    if (createTagBtn) {
        createTagBtn.addEventListener('click', handleCreateTag);
    }

    if (newTagInput) {
        newTagInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleCreateTag();
            }
        });
    }
</script>
{% endblock  %}
