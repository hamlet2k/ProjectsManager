<nav class="navbar navbar-expand-md mx-2 my-2 bg-body-tertiary border border-secondary-subtle rounded">
  <div class="container-fluid d-flex align-items-center flex-wrap">
    {% set notifications_summary = notification_summary or {} %}
    {% set notification_count_raw = notifications_summary.badge_count if notifications_summary.badge_count is defined else notifications_summary.new_count if notifications_summary.new_count is defined else notifications_summary.pending_count %}
    {% if notification_count_raw is number %}
    {% set notification_count_value = notification_count_raw %}
    {% elif notification_count_raw is not none %}
    {% set notification_count_value = notification_count_raw | int %}
    {% else %}
    {% set notification_count_value = 0 %}
    {% endif %}
    {% if notification_count_value > 9 %}
    {% set notification_badge_label = '9+' %}
    {% elif notification_count_value > 0 %}
    {% set notification_badge_label = notification_count_value %}
    {% else %}
    {% set notification_badge_label = 0 %}
    {% endif %}
    {% set on_scope_list = request.endpoint == 'scopes.list_scopes' %}
    {% if not on_scope_list %}
    <a
      class="btn btn-link p-0 me-2 d-inline-flex d-md-none align-items-center justify-content-center"
      href="{{ url_for('scopes.list_scopes') if g.scope else url_for('home') }}"
      aria-label="Back to project selection"
      data-navbar-tooltip
      data-bs-placement="bottom"
      title="Back to projects"
    >
      <i class="bi bi-arrow-left-circle fs-4" aria-hidden="true"></i>
      <span class="visually-hidden">Back to project selection</span>
    </a>
    {% else %}
    <a
      class="navbar-brand d-inline-flex d-md-none align-items-center gap-2 me-2"
      href="{{ url_for('home') }}"
      aria-label="Projects Manager home"
      title="Projects Manager"
    >
      <img
        src="{{ url_for('static', filename='images/fav-big.png') }}"
        alt="Projects Manager"
        width="30"
        height="30"
        class="d-inline-block"
      />
      <span class="visually-hidden">Projects Manager</span>
    </a>
    {% endif %}

    <a
      class="navbar-brand d-none d-md-inline-flex align-items-center gap-2 text-truncate"
      href="{{ url_for('scopes.list_scopes') if g.scope else url_for('home') }}"
      aria-label="Back to project selection"
      data-navbar-tooltip
      data-bs-placement="bottom"
      title="Back to projects"
    >
      <img
        src="{{ url_for('static', filename='images/fav-big.png') }}"
        alt="Projects Manager"
        width="30"
        height="30"
        class="d-inline-block"
      />
      <span class="visually-hidden">Back to projects</span>
    </a>

    {% if not on_scope_list %}
    <a
      class="btn btn-link p-0 me-2 d-none d-md-inline-flex align-items-center justify-content-center"
      href="{{ url_for('scopes.list_scopes') if g.scope else url_for('home') }}"
      aria-label="Back to project selection"
      data-navbar-tooltip
      data-bs-placement="bottom"
      title="Back to projects"
    >
      <i class="bi bi-arrow-left-circle fs-4" aria-hidden="true"></i>
      <span class="visually-hidden">Back to project selection</span>
    </a>
    {% endif %}

    {% if g.scope %}
    <a
      class="navbar-brand d-flex d-md-none align-items-center gap-2 mb-0 text-truncate flex-grow-1"
      href="{{ url_for('task') }}"
      aria-label="Reload {{ g.scope.name }} tasks"
      title="Reload project tasks"
    >
      <span class="fw-semibold text-truncate">{{ g.scope.name }}</span>
    </a>
    <a
      class="navbar-brand d-none d-md-inline-flex align-items-center gap-2 mb-0 text-truncate"
      href="{{ url_for('task') }}"
      aria-label="Reload {{ g.scope.name }} tasks"
      data-navbar-tooltip
      data-bs-placement="bottom"
      title="Reload project tasks"
    >
      <span class="fw-semibold text-truncate" style="max-width: 18rem">{{ g.scope.name }}</span>
    </a>
    {% else %}
    <a
      class="navbar-brand d-flex d-md-none align-items-center gap-2 mb-0 text-truncate flex-grow-1"
      href="{{ url_for('home') }}"
      aria-label="Go to Projects Manager home"
      title="Projects Manager"
    >
      <span class="fw-semibold text-truncate">Projects Manager</span>
    </a>
    <a
      class="navbar-brand d-none d-md-inline-flex align-items-center gap-2 mb-0 text-truncate"
      href="{{ url_for('home') }}"
      aria-label="Go to Projects Manager home"
      data-navbar-tooltip
      data-bs-placement="bottom"
      title="Projects Manager"
    >
      <span class="fw-semibold text-truncate" style="max-width: 18rem">Projects Manager</span>
    </a>
    {% endif %}

    <button
      class="navbar-toggler ms-auto position-relative"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNav"
      aria-controls="navbarNav"
      aria-expanded="false"
      aria-label="Toggle navigation"
      data-notification-badge-target
      data-notification-badge-class="badge rounded-pill text-bg-danger notification-count-badge notification-count-badge--menu position-absolute top-0 start-100 translate-middle"
    >
      <span class="navbar-toggler-icon"></span>
      {% if notification_count_value %}
      <span
        class="badge rounded-pill text-bg-danger notification-count-badge notification-count-badge--menu position-absolute top-0 start-100 translate-middle"
        data-notification-count
        aria-hidden="true"
      >
        {{ notification_badge_label }}
      </span>
      {% endif %}
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <div class="d-flex flex-column flex-md-row w-100 gap-3 gap-md-3 py-3 py-md-0 align-items-stretch align-items-md-center">
        <ul class="navbar-nav flex-column flex-md-row gap-2 align-items-stretch align-items-md-center" data-nav-section="left">
          <li class="nav-item d-md-none">
            <a
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              href="{{ url_for('scopes.list_scopes') if g.scope else url_for('home') }}"
              aria-label="Back to project selection"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Back to projects"
            >
              <i class="bi bi-arrow-left-circle" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Back to projects</span>
            </a>
          </li>
          {% if g.scope %}
          <li class="nav-item d-md-none">
            <a
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center gap-2 text-body text-truncate"
              href="{{ url_for('task') }}"
              aria-label="Reload {{ g.scope.name }} tasks"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Reload project tasks"
            >
              <i class="bi bi-kanban" aria-hidden="true"></i>
              <span class="flex-grow-1 text-start text-truncate">{{ g.scope.name }}</span>
            </a>
          </li>
          {% else %}
          <li class="nav-item d-md-none">
            <a
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center gap-2 text-body text-truncate"
              href="{{ url_for('home') }}"
              aria-label="Go to Projects Manager home"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Projects Manager"
            >
              <i class="bi bi-kanban" aria-hidden="true"></i>
              <span class="flex-grow-1 text-start text-truncate">Projects Manager</span>
            </a>
          </li>
          {% endif %}
        </ul>

        <ul
          class="navbar-nav flex-column flex-md-row gap-2 align-items-stretch align-items-md-center justify-content-start justify-content-md-end flex-grow-1"
          data-nav-section="center"
        >
          {% if g.user and g.user.github_integration_enabled %}
          <li class="nav-item">
            <button
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              type="button"
              id="github-refresh-btn"
              aria-label="Sync integrations"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Sync integrations"
            >
              <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Sync integrations</span>
            </button>
          </li>
          {% endif %}

          {% if g.scope and g.user and g.scope.owner_id == g.user.id %}
          {% set share_summary = g.scope.share_summary if g.scope.share_summary is defined else None %}
          {% set share_count = share_summary.accepted if share_summary else 0 %}
          {% set has_pending = share_summary.pending if share_summary else 0 %}
          {% set show_nav_share = request.endpoint in ['task', 'add_task', 'edit_task'] %}
          {% if show_nav_share %}
          <li class="nav-item">
            <button
              type="button"
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 scope-share-btn {{ 'text-primary' if share_count else 'text-body' }}"
              data-scope-id="{{ g.scope.id }}"
              data-share-count="{{ share_count }}"
              data-share-pending="{{ 'true' if has_pending else 'false' }}"
              data-share-variant="nav"
              aria-label="Share project"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Share project"
            >
              <i class="bi {{ 'bi-share-fill' if share_count else 'bi-share' }}" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Share project</span>
            </button>
          </li>
          {% endif %}
          {% endif %}

          {% if g.user %}
          <li class="nav-item">
            <button
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#feedbackModal"
              aria-label="Share feedback"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Share feedback"
            >
              <i class="bi bi-chat-dots" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Feedback</span>
            </button>
          </li>

          {% set summary = notifications_summary %}
          {% set notification_count = notification_count_value %}
          <li class="nav-item dropdown notifications-dropdown" data-notifications-root>
            <a
              class="btn btn-link nav-link nav-link-responsive position-relative d-flex d-md-none align-items-center justify-content-start gap-2 text-body"
              href="{{ url_for('notifications.list_notifications') }}"
              aria-label="Notifications"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Notifications"
              data-notification-badge-target
              data-notification-badge-class="badge rounded-pill text-bg-danger notification-count-badge position-absolute top-0 start-100 translate-middle"
            >
              <i class="bi bi-bell" aria-hidden="true"></i>
              <span class="flex-grow-1 text-start">Notifications</span>
              {% if notification_count %}
              <span
                class="badge rounded-pill text-bg-danger notification-count-badge position-absolute top-0 start-100 translate-middle"
                data-notification-count
                aria-hidden="true"
              >
                {{ notification_badge_label }}
              </span>
              {% endif %}
            </a>
            <button
              class="btn btn-link nav-link nav-link-responsive position-relative d-none d-md-flex align-items-center justify-content-md-center gap-2 text-body"
              type="button"
              id="notificationDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              aria-label="Notifications"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Notifications"
              data-notification-toggle
              data-notification-badge-target
              data-notification-badge-class="badge rounded-pill text-bg-danger notification-count-badge position-absolute top-0 start-100 translate-middle"
            >
              <i class="bi bi-bell" aria-hidden="true"></i>
              {% if notification_count %}
              <span
                class="badge rounded-pill text-bg-danger notification-count-badge position-absolute top-0 start-100 translate-middle"
                data-notification-count
                aria-hidden="true"
              >
                {{ notification_badge_label }}
              </span>
              {% endif %}
            </button>
            <div class="dropdown-menu dropdown-menu-end p-0 shadow notification-dropdown-menu" aria-labelledby="notificationDropdown">
              <div class="notification-list" data-notification-list>
                {% set pending = summary.pending or [] %}
                {% set pending_ids = pending | map(attribute='id') | list %}
                {% set recent = summary.recent or [] %}
                {% if pending or recent %}
                  {% for note in pending %}
                    {% with notification=note, compact=True %}
                      {% include 'partials/notification_item.html' %}
                    {% endwith %}
                  {% endfor %}
                  {% for note in recent %}
                    {% if note.id not in pending_ids %}
                      {% with notification=note, compact=True %}
                        {% include 'partials/notification_item.html' %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <div class="notification-empty text-muted small" data-notification-empty>No notifications yet.</div>
                {% endif %}
              </div>
              <div class="notification-dropdown-footer text-center">
                <a class="dropdown-item" href="{{ url_for('notifications.list_notifications') }}">View all notifications</a>
              </div>
            </div>
            <input type="hidden" data-notification-csrf value="{{ summary.csrf_token or '' }}" />
          </li>

          <li class="nav-item" data-profile-menu-root>
            <a
              href="{{ url_for('user') }}"
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              aria-label="Profile"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Profile"
              data-profile-menu-trigger
            >
              <i class="bi bi-person-circle" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Profile</span>
            </a>
          </li>

          <li class="nav-item">
            <a
              href="{{ url_for('settings') }}"
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              aria-label="Settings"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Settings"
            >
              <i class="bi bi-gear" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Settings</span>
            </a>
          </li>
          {% endif %}
        </ul>

        <div class="d-none d-md-flex align-self-stretch mx-md-1 navbar-divider-tight">
          <div class="vr text-body-secondary opacity-50 navbar-divider-tight"></div>
        </div>

        <ul
          class="navbar-nav flex-column flex-md-row gap-2 align-items-stretch align-items-md-center justify-content-start justify-content-md-end flex-grow-0 flex-shrink-0"
          data-nav-section="right"
        >
          {% if 'user' in session %}
          <li class="nav-item">
            <a
              href="{{ url_for('logout') }}"
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              aria-label="Logout"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Logout"
            >
              <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Logout</span>
            </a>
          </li>
          {% else %}
          <li class="nav-item">
            <a
              href="{{ url_for('login') }}"
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              aria-label="Login"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Login"
            >
              <i class="bi bi-box-arrow-in-right" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Login</span>
            </a>
          </li>
          {% endif %}

          <li class="nav-item">
            {% include 'components/theme_menu.html' %}
          </li>

          <li class="nav-item">
            <button
              class="btn btn-link nav-link nav-link-responsive d-flex align-items-center justify-content-start justify-content-md-center gap-2 text-body"
              type="button"
              aria-label="Help and documentation"
              aria-disabled="true"
              data-navbar-tooltip
              data-bs-placement="bottom"
              title="Help &amp; Docs (coming soon)"
              data-placeholder-help
            >
              <i class="bi bi-question-circle" aria-hidden="true"></i>
              <span class="d-md-none flex-grow-1 text-start">Help &amp; Docs</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>
