{% extends "base.html" %}

{% block css %}
{{ super() }}
<style>
.sketchy-border {
    border-radius: 25px 25px 55px 5px/5px 55px 25px 25px; 
    border: 1.2px solid #6b6b6b;
}
.no-visited:visited {
    color: inherit;
}
.clickable-icon {
    cursor: pointer;
}
#grip {
    cursor: move; /* Change cursor to indicate movability */
}

.alert {
    transition: opacity 1s ease-out, height 1s ease-out, padding 1s ease-out, margin 1s ease-out;
    opacity: 1; /* Initial opacity */
    overflow: hidden; /* Prevent content from spilling during height transition */
}

.modal-content {
    border-radius: 1rem;
    border: 1px solid var(--bs-border-color);
    background-color: var(--bs-body-bg);
    box-shadow: 0 0.75rem 2rem rgba(33, 37, 41, 0.2);
}

.modal-header {
    border-bottom: 1px solid var(--bs-border-color);
}

.modal-footer {
    border-top: 1px solid var(--bs-border-color);
}

.modal-title {
    font-weight: 600;
}


.markdown-content {
    font-size: 92%;
    line-height: 1.4;
}
.markdown-content h1 {
    font-size: 1.4em;
}
.markdown-content h2 {
    font-size: 1.2em;
}
.markdown-content h3 {
    font-size: 1.1em;
}
.markdown-content h4 {
    font-size: 1.05em;
}
.markdown-content h5 {
    font-size: 1em;
}
.markdown-content h6 {
    font-size: 0.95em;
}
.markdown-content p:last-child,
.markdown-content ul:last-child,
.markdown-content ol:last-child,
.markdown-content pre:last-child {
    margin-bottom: 0;
}
.markdown-content ul,
.markdown-content ol {
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
}
.markdown-content pre {
    padding: 0.5rem;
    background-color: var(--bs-tertiary-bg);
    border-radius: 0.5rem;
    overflow: auto;
}
.markdown-content code {
    font-size: inherit;
    background-color: var(--bs-tertiary-bg);
    padding: 0.1rem 0.25rem;
    border-radius: 0.25rem;
}
.markdown-content table {
    --pm-table-surface: color-mix(in srgb, var(--bs-body-bg) 96%, var(--bs-body-color) 4%);
    --pm-table-stripe: color-mix(in srgb, var(--bs-tertiary-bg) 94%, var(--bs-body-color) 6%);
    --pm-table-hover: color-mix(in srgb, var(--bs-tertiary-bg) 90%, var(--bs-body-color) 10%);
    --pm-table-header: color-mix(in srgb, var(--bs-secondary-bg) 88%, var(--bs-body-color) 12%);
    --pm-table-border: var(--bs-border-color);
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0.75rem 0;
    font-size: inherit;
    background-color: var(--bs-body-bg);
    background-color: var(--pm-table-surface);
    color: var(--bs-body-color);
    border: 1px solid var(--pm-table-border);
    border-radius: 0.5rem;
    overflow: hidden;
}
.markdown-content thead th {
    background-color: var(--bs-secondary-bg);
    background-color: var(--pm-table-header);
    color: var(--bs-body-color);
    font-weight: 600;
    text-align: left;
}
.markdown-content th,
.markdown-content td {
    padding: 0.5rem 0.75rem;
    border-right: 1px solid var(--pm-table-border);
    border-bottom: 1px solid var(--pm-table-border);
    vertical-align: top;
}
.markdown-content td {
    background-color: transparent;
}
.markdown-content th:last-child,
.markdown-content td:last-child {
    border-right: none;
}
.markdown-content tr:last-child td {
    border-bottom: none;
}
.markdown-content tbody tr:nth-child(odd) {
    background-color: var(--bs-body-bg);
    background-color: var(--pm-table-surface);
}
.markdown-content tbody tr:nth-child(even) {
    background-color: var(--bs-tertiary-bg);
    background-color: var(--pm-table-stripe);
}
.markdown-content tbody tr:nth-child(odd) td {
    background-color: var(--pm-table-surface);
}
.markdown-content tbody tr:nth-child(even) td {
    background-color: var(--pm-table-stripe);
}
.markdown-content tbody tr:hover {
    background-color: var(--bs-secondary-bg);
    background-color: var(--pm-table-hover);
}
.markdown-content tbody tr:hover td {
    background-color: var(--pm-table-hover);
}
[data-bs-theme="dark"] .markdown-content table {
    --pm-table-surface: var(--bs-dark-bg-subtle, #1a1a1a);
    --pm-table-stripe: color-mix(in srgb, var(--bs-tertiary-bg) 85%, var(--bs-dark-bg-subtle, #1a1a1a) 15%);
    --pm-table-hover: color-mix(in srgb, var(--bs-secondary-bg) 70%, var(--bs-body-color) 30%);
    --pm-table-header: color-mix(in srgb, var(--bs-secondary-bg) 65%, var(--bs-body-color) 35%);
    --pm-table-border: var(--bs-dark-border-subtle, #333);
}
[data-bs-theme="dark"] .markdown-content tbody tr:nth-child(odd) {
    background-color: var(--bs-dark-bg-subtle, #1a1a1a);
    background-color: var(--pm-table-surface);
}
[data-bs-theme="dark"] .markdown-content tbody tr:nth-child(even) {
    background-color: var(--bs-secondary-bg, #333);
    background-color: var(--pm-table-stripe);
}
[data-bs-theme="dark"] .markdown-content tbody tr:hover {
    background-color: var(--bs-secondary-bg, #333);
    background-color: var(--pm-table-hover);
}
[data-bs-theme="dark"] .markdown-content thead th {
    background-color: var(--bs-secondary-bg, #333);
    background-color: var(--pm-table-header);
}

</style>
{% endblock css %}


{% block scripts %}
    {{ super() }}

    <script src="{{ url_for('static', filename='js/clipboard.js') }}"></script>

<script>
    window.displayFlashMessage = function(message, type = 'info') {
        const flashContainer = document.getElementById('flash-container');
        const target = flashContainer || document.body;
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-2`;
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        if (target.firstChild) {
            target.insertBefore(alert, target.firstChild);
        } else {
            target.appendChild(alert);
        }

        if (type === 'success' || type === 'info') {
            window.setTimeout(() => {
                const instance = bootstrap.Alert.getOrCreateInstance(alert);
                instance.close();
            }, 5000);
        }
    };

    function expandAccordionItem(accordionItemId) {
        var toggleElement = document.querySelector(`[data-bs-target="#${accordionItemId}"]`);
        if (toggleElement && toggleElement.classList.contains('collapsed')) {
            toggleElement.click();
        }
    }


    function collapseAccordionItem(accordionItemId) {
        var toggleElement = document.querySelector(`[data-bs-target="#${accordionItemId}"]`);
        if (toggleElement && !toggleElement.classList.contains('collapsed')) {
            toggleElement.click();
        }
    }


    function initializeSortable(listId, itemType) {
        var el = document.getElementById(listId);

        if (!el) return; // Exit if element is not found

        var sortable = Sortable.create(el, {
            handle: "#grip", // Only allow drag using the grip icon
            onEnd: function () {
                updateRank(listId, itemType); // Pass accordionId and itemType
            },
        });
    }

    function updateRank(listId, itemType) {
        var orderedIds = [];
        document.querySelectorAll(`#${listId} #grip`)
            .forEach(function (item, index) {
                orderedIds.push({
                    id: item.getAttribute("data-item-id"),
                    newRank: index + 1, // Assuming rank starts at 1
                });
            });

        fetch(`/${itemType}/rank`, { // Use the itemType in the URL
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.getElementById("csrf_token").value, // Include CSRF token
            },
            body: JSON.stringify({ items: orderedIds }),
        })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                // Rank updated successfully - no logging needed
            }
        })
        .catch((error) => console.error("Error:", error));
    }

    document.addEventListener('DOMContentLoaded', () => {
        const refreshButton = document.getElementById('github-refresh-btn');
        if (!refreshButton) {
            return;
        }
        refreshButton.addEventListener('click', () => {
            const csrfField = document.querySelector('input[name="csrf_token"]');
            const csrfToken = csrfField ? csrfField.value : null;
            const originalContent = refreshButton.innerHTML;
            refreshButton.disabled = true;
            refreshButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            fetch('/api/github/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}),
                },
            })
                .then((response) =>
                    response
                        .json()
                        .catch(() => ({}))
                        .then((data) => ({ ok: response.ok, data }))
                )
                .then(({ ok, data }) => {
                    if (!ok || !data || !data.success) {
                        const message = (data && data.message) || 'Unable to refresh GitHub data.';
                        displayFlashMessage(message, 'danger');
                        return;
                    }
                    const count = Number(data.updated || 0);
                    const summary = `GitHub sync complete â€” ${count} task${count === 1 ? '' : 's'} updated.`;
                    displayFlashMessage(summary, 'success');
                    if (typeof refreshTaskList === 'function') {
                        refreshTaskList();
                    }
                })
                .catch((error) => {
                    console.error('Unable to refresh GitHub data', error);
                    displayFlashMessage('Unable to refresh GitHub data.', 'danger');
                })
                .finally(() => {
                    refreshButton.disabled = false;
                    refreshButton.innerHTML = originalContent;
                });
        });
    });

</script>
{% endblock %}
